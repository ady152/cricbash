<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cricbash - Pack Opening & Dream Team</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap');
  body {
    margin: 0; padding: 0;
    background: #121212;
    color: #eee;
    font-family: 'Poppins', sans-serif;
  }
  header {
    background: #222;
    padding: 1rem 2rem;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #333;
  }
  header h1 {
    margin: 0; font-weight: 700; letter-spacing: 1.5px;
  }
  #authButtons button {
    background: #3a86ff;
    border: none; border-radius: 5px;
    padding: 0.5rem 1rem;
    margin-left: 0.5rem;
    color: white; font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #authButtons button:hover {
    background: #265df2;
  }
  main {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
  }
  #packStore, #ownedCards, #dreamTeam {
    background: #1f1f1f;
    border-radius: 10px;
    padding: 1rem;
    flex: 1 1 350px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
  }
  h2 {
    margin-top: 0;
    border-bottom: 1px solid #444;
    padding-bottom: 0.5rem;
  }
  /* Pack store buttons */
  .pack-btn {
    background: #3a86ff;
    border: none;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
    text-align: center;
  }
  .pack-btn:hover:not(:disabled) {
    background: #265df2;
  }
  .pack-btn:disabled {
    background: #555;
    cursor: not-allowed;
  }
  /* Cards container */
  .cards-container {
    flex-grow: 1;
    overflow-y: auto;
    margin-top: 0.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding-right: 5px;
  }
  /* Single card style */
  .card {
    background: #272727;
    border-radius: 8px;
    width: 110px;
    height: 140px;
    color: white;
    box-shadow: 0 0 8px #000;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    position: relative;
  }
  .rarity-standard { border: 2px solid #ccc; }
  .rarity-rare { border: 2px solid #4db8ff; }
  .rarity-elite { border: 2px solid #ffcc29; }
  .rarity-legendary { border: 2px solid #ff6f61; }
  .rarity-icon { border: 2px solid #9b59b6; }
  .card-name {
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card-role {
    font-size: 0.8rem;
    color: #bbb;
  }
  /* Tooltip for add/remove */
  .tooltip {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: rgba(0,0,0,0.6);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    user-select: none;
  }
  /* Dream Team player selected */
  .card.selected {
    box-shadow: 0 0 10px 3px #3aff7d;
  }
  /* Scrollbar style */
  .cards-container::-webkit-scrollbar {
    width: 8px;
  }
  .cards-container::-webkit-scrollbar-track {
    background: #1f1f1f;
  }
  .cards-container::-webkit-scrollbar-thumb {
    background-color: #3a86ff;
    border-radius: 10px;
  }
  /* Pack opening animation */
  #packOpening {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: #eee;
    font-size: 1.3rem;
    z-index: 100;
    display: none;
  }
  #packOpening .cards-container {
    margin-top: 1rem;
    max-width: 90vw;
    flex-wrap: nowrap;
    overflow-x: auto;
  }
</style>
</head>
<body>
<header>
  <h1>Cricbash</h1>
  <div id="authButtons">
    <button id="btnLogin">Log In</button>
    <button id="btnSignup">Sign Up</button>
  </div>
  <div id="userPanel" style="display:none;">
    <span id="userEmail"></span>
    <button id="btnLogout" style="margin-left: 1rem; background:#e03c3c;">Logout</button>
  </div>
</header>

<!-- Pack opening modal -->
<div id="packOpening">
  <div>Opening pack...</div>
  <div class="cards-container" id="packCards"></div>
  <button id="closePackBtn" style="margin-top:1rem; padding: 0.5rem 1rem; cursor:pointer;">Close</button>
</div>

<main>
  <section id="packStore">
    <h2>Pack Store</h2>
    <button class="pack-btn" data-pack="bronze" id="btnBronzePack">Bronze Pack - 100 Coins</button>
    <button class="pack-btn" data-pack="silver" id="btnSilverPack">Silver Pack - 300 Coins</button>
    <button class="pack-btn" data-pack="gold" id="btnGoldPack">Gold Pack - 700 Coins</button>
    <div style="margin-top:1rem; font-weight:700;">Your Coins: <span id="coinDisplay">0</span></div>
  </section>

  <section id="ownedCards">
    <h2>Your Cards (Click to add/remove to Dream Team)</h2>
    <div class="cards-container" id="cardsContainer"></div>
  </section>

  <section id="dreamTeam">
    <h2>Dream Team (Max 11 Players)</h2>
    <div class="cards-container" id="dreamTeamContainer"></div>
  </section>
</main>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  // Your Firebase config here (replace with your project)
  const firebaseConfig = {
    apiKey: "AIzaSyBFOIy-AC31RFfqWzxKklhawE7QAm5_D-I",
    authDomain: "cricbash-bab6c.firebaseapp.com",
    projectId: "cricbash-bab6c",
    storageBucket: "cricbash-bab6c.appspot.com",
    messagingSenderId: "361682550397",
    appId: "1:361682550397:web:eac03d09959365e93dfb14",
    measurementId: "G-7GVZGWVFRC"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ----- Player Data -----
  // Cards (you will replace these with your real cards & images)
  // Format: id, name, role, rarity, unique code
  const allCards = [
    { id: 'JS-01', name: 'J Sharma', role: 'Wicket Keeper', rarity: 'rare' },
    { id: 'PD-01', name: 'P Dubey', role: 'Bowler Leggie', rarity: 'standard' },
    { id: 'RD-01', name: 'R Dhawan', role: 'All Rounder (Fast Bowler)', rarity: 'standard' },
    { id: 'TK-01', name: 'Tanush Kotian', role: 'All Rounder Off Spinner', rarity: 'standard' },
    { id: 'SS-01', name: 'Sai Sudarshan', role: 'Batsman', rarity: 'rare' },
    { id: 'SY-01', name: 'Suryakumar Yadav', role: 'Batsman', rarity: 'elite' },
    { id: 'KT-01', name: 'K L Rahul', role: 'Batsman', rarity: 'elite' },
    { id: 'VK-01', name: 'Virat Kohli', role: 'Batsman', rarity: 'legendary' },
    { id: 'MS-01', name: 'M S Dhoni', role: 'Wicket Keeper', rarity: 'legendary' },
    { id: 'AR-01', name: 'Amit Raina', role: 'Bowler Fast', rarity: 'standard' },
    { id: 'AB-01', name: 'AB de Villiers', role: 'Batsman', rarity: 'legendary' },
    { id: 'CR-01', name: 'Chris Gayle', role: 'Batsman', rarity: 'elite' },
    { id: 'RG-01', name: 'Ravindra Jadeja', role: 'All Rounder Spinner', rarity: 'elite' },
    { id: 'JJ-01', name: 'Jasprit Bumrah', role: 'Bowler Fast', rarity: 'legendary' },
    { id: 'KL-01', name: 'KL Rahul', role: 'Batsman', rarity: 'elite' },
    { id: 'RS-01', name: 'Rishabh Pant', role: 'Wicket Keeper', rarity: 'elite' },
  ];

  // Pack details: name, cost, count, rarity probabilities (rarity: chance%)
  const packs = {
    bronze: { cost: 100, cardsCount: 3, rarityChances: { standard: 70, rare: 25, elite: 5 } },
    silver: { cost: 300, cardsCount: 5, rarityChances: { standard: 50, rare: 35, elite: 10, legendary: 5 } },
    gold: { cost: 700, cardsCount: 7, rarityChances: { rare: 40, elite: 40, legendary: 15, icon: 5 } }
  };

  // UI elements
  const coinDisplay = document.getElementById('coinDisplay');
  const cardsContainer = document.getElementById('cardsContainer');
  const dreamTeamContainer = document.getElementById('dreamTeamContainer');
  const packOpeningDiv = document.getElementById('packOpening');
  const packCardsDiv = document.getElementById('packCards');
  const closePackBtn = document.getElementById('closePackBtn');
  const btnBronzePack = document.getElementById('btnBronzePack');
  const btnSilverPack = document.getElementById('btnSilverPack');
  const btnGoldPack = document.getElementById('btnGoldPack');

  // Auth UI Elements
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');
  const btnLogout = document.getElementById('btnLogout');
  const authButtonsDiv = document.getElementById('authButtons');
  const userPanel = document.getElementById('userPanel');
  const userEmailSpan = document.getElementById('userEmail');

  // User data variables
  let currentUser = null;
  let userCoins = 0;
  let userCards = [];      // Array of card ids owned
  let userDreamTeam = [];  // Array of card ids selected in Dream Team (max 11)

  // Helper: Get cards by rarity
  function getCardsByRarity(rarity) {
    return allCards.filter(c => c.rarity === rarity);
  }

  // Helper: Random rarity based on chances
  function getRandomRarity(rarityChances) {
    const rand = Math.random() * 100;
    let sum = 0;
    for (const rarity in rarityChances) {
      sum += rarityChances[rarity];
      if (rand <= sum) return rarity;
    }
    // fallback
    return Object.keys(rarityChances)[0];
  }

  // Helper: Pick a random card from allowed rarity excluding duplicates
  function pickRandomCardForPack(rarity, excludedIds) {
    const candidates = allCards.filter(c => c.rarity === rarity && !excludedIds.includes(c.id));
    if (candidates.length === 0) return null;
    const idx = Math.floor(Math.random() * candidates.length);
    return candidates[idx];
  }

  // Save user data to Firestore
  async function saveUserData() {
    if (!currentUser) return;
    const userDocRef = doc(db, 'users', currentUser.uid);
    try {
      await setDoc(userDocRef, {
        coins: userCoins,
        cards: userCards,
        dreamTeam: userDreamTeam
      }, { merge: true });
    } catch (err) {
      alert('Error saving user data: ' + err.message);
    }
  }

  // Load user data from Firestore
  async function loadUserData(uid) {
    const userDocRef = doc(db, 'users', uid);
    const docSnap = await getDoc(userDocRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      userCoins = data.coins ?? 0;
      userCards = data.cards ?? [];
      userDreamTeam = data.dreamTeam ?? [];
    } else {
      // New user - give 1000 coins starter + empty cards/dream team
      userCoins = 1000;
      userCards = [];
      userDreamTeam = [];
      await saveUserData();
    }
  }

  // Render coins count & pack buttons enabled/disabled
  function updateCoinsAndPackButtons() {
    coinDisplay.textContent = userCoins;
    btnBronzePack.disabled = userCoins < packs.bronze.cost;
    btnSilverPack.disabled = userCoins < packs.silver.cost;
    btnGoldPack.disabled = userCoins < packs.gold.cost;
  }

  // Render owned cards
  function renderOwnedCards() {
    cardsContainer.innerHTML = '';
    if (userCards.length === 0) {
      cardsContainer.innerHTML = '<p style="color:#777;">No cards yet. Open some packs!</p>';
      return;
    }
    userCards.forEach(cardId => {
      const cardData = allCards.find(c => c.id === cardId);
      if (!cardData) return;
      const cardEl = document.createElement('div');
      cardEl.className = 'card rarity-' + cardData.rarity;
      if (userDreamTeam.includes(cardId)) {
        cardEl.classList.add('selected');
      }
      cardEl.title = `${cardData.name} - ${cardData.role} (${cardData.rarity.toUpperCase()})`;
      cardEl.innerHTML = `
        <div class="card-name">${cardData.name}</div>
        <div class="card-role">${cardData.role}</div>
        <div class="tooltip">${userDreamTeam.includes(cardId) ? 'Remove from Dream Team' : 'Add to Dream Team'}</div>
      `;
      cardEl.onclick = () => toggleDreamTeam(cardId);
      cardsContainer.appendChild(cardEl);
    });
  }

  // Render Dream Team cards
  function renderDreamTeam() {
    dreamTeamContainer.innerHTML = '';
    if (userDreamTeam.length === 0) {
      dreamTeamContainer.innerHTML = '<p style="color:#777;">Dream Team is empty. Add players from your cards.</p>';
      return;
    }
    userDreamTeam.forEach(cardId => {
      const cardData = allCards.find(c => c.id === cardId);
      if (!cardData) return;
      const cardEl = document.createElement('div');
      cardEl.className = 'card rarity-' + cardData.rarity + ' selected';
      cardEl.title = `${cardData.name} - ${cardData.role} (${cardData.rarity.toUpperCase()})`;
      cardEl.innerHTML = `
        <div class="card-name">${cardData.name}</div>
        <div class="card-role">${cardData.role}</div>
        <div class="tooltip">Remove from Dream Team</div>
      `;
      cardEl.onclick = () => toggleDreamTeam(cardId);
      dreamTeamContainer.appendChild(cardEl);
    });
  }

  // Add or remove player from Dream Team with max 11 players
  function toggleDreamTeam(cardId) {
    const inDreamTeam = userDreamTeam.includes(cardId);
    if (inDreamTeam) {
      userDreamTeam = userDreamTeam.filter(id => id !== cardId);
    } else {
      if (userDreamTeam.length >= 11) {
        alert('Dream Team is full (max 11 players). Remove some players first.');
        return;
      }
      userDreamTeam.push(cardId);
    }
    saveUserData();
    renderOwnedCards();
    renderDreamTeam();
  }

  // Show pack opening modal with cards
  function showPackOpening(cards) {
    packCardsDiv.innerHTML = '';
    cards.forEach(card => {
      const cardEl = document.createElement('div');
      cardEl.className = 'card rarity-' + card.rarity;
      cardEl.title = `${card.name} - ${card.role} (${card.rarity.toUpperCase()})`;
      cardEl.innerHTML = `
        <div class="card-name">${card.name}</div>
        <div class="card-role">${card.role}</div>
      `;
      packCardsDiv.appendChild(cardEl);
    });
    packOpeningDiv.style.display = 'flex';
  }

  // Hide pack opening modal
  function hidePackOpening() {
    packOpeningDiv.style.display = 'none';
  }

  // Open pack logic
  async function openPack(packKey) {
    if (!currentUser) {
      alert('You must be logged in to open packs!');
      return;
    }
    const pack = packs[packKey];
    if (userCoins < pack.cost) {
      alert('Not enough coins!');
      return;
    }

    // Deduct coins first
    userCoins -= pack.cost;
    updateCoinsAndPackButtons();
    saveUserData();

    const newCards = [];
    const pickedIds = [];

    for (let i = 0; i < pack.cardsCount; i++) {
      const rarity = getRandomRarity(pack.rarityChances);
      const card = pickRandomCardForPack(rarity, pickedIds);
      if (card) {
        newCards.push(card);
        pickedIds.push(card.id);
      }
    }

    // Add new cards to user's collection (avoid duplicates)
    newCards.forEach(card => {
      if (!userCards.includes(card.id)) {
        userCards.push(card.id);
      }
    });

    await saveUserData();

    renderOwnedCards();
    updateCoinsAndPackButtons();
    showPackOpening(newCards);
  }

  // Firebase Auth state changed handler
  onAuthStateChanged(auth, async user => {
    currentUser = user;
    if (user) {
      userEmailSpan.textContent = user.email;
      authButtonsDiv.style.display = 'none';
      userPanel.style.display = 'block';
      await loadUserData(user.uid);
      updateCoinsAndPackButtons();
      renderOwnedCards();
      renderDreamTeam();
    } else {
      userEmailSpan.textContent = '';
      authButtonsDiv.style.display = 'block';
      userPanel.style.display = 'none';
      userCoins = 0;
      userCards = [];
      userDreamTeam = [];
      updateCoinsAndPackButtons();
      renderOwnedCards();
      renderDreamTeam();
    }
  });

  // Login form handler
  btnLogin.onclick = async () => {
    const email = prompt('Enter email');
    if (!email) return;
    const password = prompt('Enter password');
    if (!password) return;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      alert('Login successful!');
    } catch (err) {
      alert('Login failed: ' + err.message);
    }
  };

  // Signup form handler
  btnSignup.onclick = async () => {
    const email = prompt('Enter email');
    if (!email) return;
    const password = prompt('Enter password (6+ chars)');
    if (!password || password.length < 6) {
      alert('Password too short!');
      return;
    }
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      alert('Signup successful! Please login.');
    } catch (err) {
      alert('Signup failed: ' + err.message);
    }
  };

  // Logout handler
  btnLogout.onclick = async () => {
    try {
      await signOut(auth);
      alert('Logged out');
    } catch (err) {
      alert('Logout error: ' + err.message);
    }
  };

  // Close pack modal
  closePackBtn.onclick = () => {
    hidePackOpening();
  };

  // Pack buttons
  btnBronzePack.onclick = () => openPack('bronze');
  btnSilverPack.onclick = () => openPack('silver');
  btnGoldPack.onclick = () => openPack('gold');

  </script>
</body>
</html>
